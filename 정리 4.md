FastAPI + Tortoise ORM + MySQL + GitHub Actions (정리본)
1. 프로젝트 개요

FastAPI: Python 비동기 웹 프레임워크

Tortoise ORM: 비동기 ORM (Django ORM 스타일)

MySQL: 주요 데이터베이스

Pytest + Coverage: 테스트 실행 및 커버리지 측정

Poetry: 의존성 관리 & 패키지 빌드

GitHub Actions: CI/CD (자동 빌드, 테스트, 정적 분석)

2. 주요 디렉터리 구조

app/

api/v1/ → API 라우터 정의

dtos/ → DTO(응답/요청 스키마)

tortoise_models/ → DB 모델 정의

configs/ → DB, ORM 설정

tests/ → Pytest 기반 테스트

migrations/ → Aerich 마이그레이션 파일

pyproject.toml → Poetry 설정, 패키지 관리

aerich.ini or pyproject.toml 내 [tool.aerich] → 마이그레이션 설정

3. FastAPI 동작 흐름

요청 (Request): 클라이언트가 특정 URL(POST /v1/mysql/meetings) 호출

라우터 (Router): APIRouter를 통해 해당 API 핸들러 실행

ORM 호출 (Tortoise ORM): DB 모델을 통해 MySQL에 데이터 삽입/조회

응답 (Response): DTO 모델(pydantic)을 통해 응답 반환

테스트 (Pytest): httpx.AsyncClient를 사용하여 실제 API 호출 모의 테스트

4. 데이터베이스 & ORM

Tortoise ORM 모델 정의 필요 (e.g. MeetingModel)

테이블 생성 방법:

개발 로컬 → Tortoise.generate_schemas() (자동 생성)

운영/CI → aerich upgrade (마이그레이션 적용)

공통 BaseModel을 만들어 timestamp, id 같은 필드를 관리할 수 있음

5. CI/CD (GitHub Actions)
실행 단계

코드 체크아웃

Python 환경 세팅

Poetry 설치 및 종속성 설치

정적 분석 도구 실행

Black (포맷팅)

Ruff (린트)

Mypy (타입 검사)

MySQL 서비스 실행

GitHub Actions services 기능으로 MySQL 컨테이너 띄움

환경변수(MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE) 지정

DB 초기화

aerich upgrade 실행 → 마이그레이션 적용

테스트 실행

pytest + coverage 실행

테스트에서 ORM이 DB에 잘 연결되는지 검증

6. 에러/문제 포인트 (자주 나옴)

404 != 200 → API 라우터 경로 불일치 (경로 prefix 잘못됨)

assert False is True → DB에 데이터가 저장되지 않음 (마이그레이션/스키마 미적용)

sysyemctl not found → GitHub Actions Ubuntu 환경에서 systemctl 사용 불가 → services 방식으로 DB 실행 필요

ln: invalid option → 타임존 설정할 때 명령어 오타 발생 가능

ModuleNotFoundError → Poetry 환경/캐싱 문제

7. 학습 포인트

FastAPI 라우터 구조

APIRouter(prefix="/v1/mysql/meetings") vs. /meeting 차이

URL prefix 하나만 달라도 테스트가 실패함

ORM 모델링

비동기 ORM의 기본: await Model.create(), await Model.filter().exists()

모델 정의와 실제 DB 테이블 스키마가 반드시 맞아야 함

마이그레이션

개발 초반에는 generate_schemas()로 충분

CI/운영은 반드시 aerich upgrade

CI/CD와 DB 연동

services.mysql 로 MySQL 컨테이너 띄우는 방식이 표준

MySQL 초기 비밀번호/데이터베이스 생성은 env 로 해결

테스트

FastAPI + httpx.AsyncClient 조합으로 실제 API 호출 테스트 가능

ORM 연동된 DB 검증까지 포함해야 신뢰할 수 있는 테스트가 됨
